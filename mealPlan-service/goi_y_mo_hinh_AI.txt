===========================================
G·ª¢I √ù M√î H√åNH AI CHO H·ªÜ TH·ªêNG TH·ª∞C ƒê∆†N
(JAVASCRIPT/NODE.JS VERSION)
===========================================

1. PH√ÇN T√çCH D·ªÆ LI·ªÜU HI·ªÜN T·∫†I
=====================================

T·ª´ code base hi·ªán t·∫°i, h·ªá th·ªëng c√≥ c√°c d·ªØ li·ªáu sau:

A. D·ªÆ LI·ªÜU NG∆Ø·ªúI D√ôNG (UserProfile t·ª´ survey-service):
   - Th√¥ng tin c√° nh√¢n: tu·ªïi, gi·ªõi t√≠nh, chi·ªÅu cao, c√¢n n·∫∑ng
   - Th√¥ng tin gia ƒë√¨nh: s·ªë l∆∞·ª£ng tr·∫ª em, thanh thi·∫øu ni√™n, ng∆∞·ªùi l·ªõn, ng∆∞·ªùi cao tu·ªïi
   - S·ªü th√≠ch ƒÉn u·ªëng: lo·∫°i ch·∫ø ƒë·ªô ƒÉn, d·ªã ·ª©ng, nguy√™n li·ªáu kh√¥ng th√≠ch
   - M·ª•c ti√™u dinh d∆∞·ª°ng: calories/ng√†y, t·ª∑ l·ªá protein/carbs/fat
   - C√¢u tr·∫£ l·ªùi kh·∫£o s√°t m·ªÅm (softQuestions)

B. D·ªÆ LI·ªÜU M√ìN ƒÇN (t·ª´ meal-service):
   - Th√¥ng tin m√≥n ƒÉn: t√™n, m√¥ t·∫£, h√¨nh ·∫£nh
   - Danh m·ª•c m√≥n ƒÉn (MealCategory)
   - T∆∞∆°ng th√≠ch ch·∫ø ƒë·ªô ƒÉn (dietaryCompatibility)
   - Nguy√™n li·ªáu v√† kh·∫©u ph·∫ßn (ingredients v·ªõi quantity/unit)
   - C√¥ng th·ª©c n·∫•u ƒÉn (recipe)
   - ƒê·ªô ph·ªï bi·∫øn (popularity)

C. D·ªÆ LI·ªÜU NGUY√äN LI·ªÜU (t·ª´ ingredient-service):
   - Th√¥ng tin dinh d∆∞·ª°ng chi ti·∫øt (calories, protein, carbs, fat)
   - Danh m·ª•c nguy√™n li·ªáu
   - ƒê∆°n v·ªã ƒëo l∆∞·ªùng

2. CHI·∫æN L∆Ø·ª¢C M·ªöI: AI DATA GENERATION + KNN
==========================================

PHASE 1: GEMINI AI DATA GENERATOR (1-2 tu·∫ßn)
--------------------------------------------

M·ª§C ƒê√çCH:
- D√πng Gemini AI ƒë·ªÉ t·∫°o ra ~100+ b·ªô d·ªØ li·ªáu user profile gi·∫£
- Generate meal selection history cho t·ª´ng user
- T·∫°o data training ch·∫•t l∆∞·ª£ng cho KNN model

TH∆Ø∆†NG VI·ªÜC C·∫¶N:
```bash
npm install @google/generative-ai axios lodash moment faker
```

FILE C·∫¶N T·∫†O:
- scripts/dataGenerator.js (main script)
- services/geminiDataService.js (AI data generation)
- utils/profileGenerator.js (user profile templates)
- utils/mealHistoryGenerator.js (meal selection simulation)
- models/TrainingDataModel.js (MongoDB schema for training data)
- scripts/runDataGeneration.js (execution script)

DETAILED WORKFLOW:

STEP 1: GEMINI PROFILE GENERATOR
-------------------------------
```javascript
// services/geminiDataService.js
const { GoogleGenerativeAI } = require('@google/generative-ai');

class GeminiDataGenerator {
  async generateUserProfiles(count = 100) {
    const prompt = `
    T·∫°o ${count} user profiles ƒëa d·∫°ng v·ªõi format JSON:
    {
      "personalInfo": {
        "age": number (18-80),
        "gender": "male/female/other", 
        "height": number (150-200cm),
        "weight": number (40-120kg)
      },
      "isFamily": boolean,
      "familyInfo": {
        "children": number (0-3),
        "teenagers": number (0-2), 
        "adults": number (1-4),
        "elderly": number (0-2)
      },
      "dietaryPreferences": {
        "DietType_id": "normal/vegetarian/vegan/ketogenic/paleo",
        "allergies": array c·ªßa strings,
        "dislikeIngredients": array c·ªßa ingredient names
      },
      "nutritionGoals": {
        "caloriesPerDay": number (1200-3000),
        "proteinPercentage": number (15-35),
        "carbPercentage": number (30-65), 
        "fatPercentage": number (20-40)
      },
      "lifestyle": {
        "activityLevel": "sedentary/moderate/active/very_active",
        "cookingSkill": "beginner/intermediate/advanced",
        "timeConstraints": "tight/moderate/flexible"
      }
    }
    
    ƒê·∫£m b·∫£o data realistic v√† ƒëa d·∫°ng v·ªÅ:
    - ƒê·ªô tu·ªïi v√† demographics
    - Dietary preferences ph√¢n b·ªë ƒë·ªÅu
    - Family vs personal profiles (60/40)
    - Nutrition goals h·ª£p l√Ω v·ªõi lifestyle
    `;
    
    const result = await this.callGemini(prompt);
    return this.parseProfiles(result);
  }
}
```

STEP 2: MEAL SELECTION SIMULATOR  
-------------------------------
```javascript
// utils/mealHistoryGenerator.js
class MealHistoryGenerator {
  async generateMealSelections(userProfile, availableMeals, daysCount = 30) {
    const prompt = `
    D·ª±a tr√™n user profile sau:
    ${JSON.stringify(userProfile)}
    
    V√† danh s√°ch meals c√≥ s·∫µn:
    ${JSON.stringify(availableMeals.slice(0, 20))} // Limit for prompt size
    
    T·∫°o meal selections history cho ${daysCount} ng√†y v·ªõi logic:
    1. Respect dietary restrictions (diet type, allergies, dislikes)
    2. Target nutrition goals 
    3. Consider family size for portions
    4. Vary meals but c√≥ patterns realistic
    5. Weekend vs weekday differences
    
    Format:
    {
      "selections": [
        {
          "date": "2024-01-01",
          "breakfast": [{"meal_id": "xxx", "portion": 1, "satisfied": true/false}],
          "lunch": [{"meal_id": "yyy", "portion": 1, "satisfied": true/false}], 
          "dinner": [{"meal_id": "zzz", "portion": 1, "satisfied": true/false}]
        }
      ]
    }
    `;
    
    return await this.callGemini(prompt);
  }
}
```

STEP 3: DATA INTEGRATION SCRIPT
------------------------------
```javascript
// scripts/dataGenerator.js
const GeminiDataGenerator = require('../services/geminiDataService');
const MealHistoryGenerator = require('../utils/mealHistoryGenerator');
const { getAllMeals } = require('../utils/apiUtils');

class DataGenerationPipeline {
  async generateTrainingData() {
    console.log('üöÄ B·∫Øt ƒë·∫ßu generate training data...');
    
    // 1. Generate user profiles
    const profiles = await this.geminiGenerator.generateUserProfiles(100);
    console.log(`‚úÖ Generated ${profiles.length} user profiles`);
    
    // 2. Get available meals from API
    const meals = await getAllMeals(process.env.ADMIN_TOKEN);
    console.log(`üìã Loaded ${meals.data.meals.length} meals`);
    
    // 3. Generate meal histories for each profile
    const trainingData = [];
    for (let i = 0; i < profiles.length; i++) {
      const profile = profiles[i];
      console.log(`üîÑ Processing user ${i+1}/${profiles.length}`);
      
      const mealHistory = await this.historyGenerator.generateMealSelections(
        profile, meals.data.meals, 30
      );
      
      trainingData.push({
        userProfile: profile,
        mealHistory: mealHistory,
        generatedAt: new Date(),
        dataQuality: 'ai_generated'
      });
      
      // Rate limiting cho Gemini API
      if (i % 5 === 0) await this.sleep(2000);
    }
    
    // 4. Save to database
    await this.saveTrainingData(trainingData);
    console.log('‚úÖ Training data generation completed!');
    
    return trainingData;
  }
  
  async saveTrainingData(data) {
    // Save to MongoDB cho training
    const TrainingData = require('../models/TrainingDataModel');
    await TrainingData.insertMany(data);
  }
}
```

PHASE 2: KNN MODEL IMPLEMENTATION (1-2 tu·∫ßn)
--------------------------------------------

TH∆Ø∆†NG VI·ªÜC C·∫¶N TH√äM:
```bash
npm install ml-knn ml-matrix ml-distance
```

FILE C·∫¶N T·∫†O:
- services/knnRecommendationService.js
- utils/featureEngineering.js  
- models/MealRecommendationModel.js
- scripts/trainKNNModel.js

DETAILED IMPLEMENTATION:

STEP 1: FEATURE ENGINEERING
--------------------------
```javascript
// utils/featureEngineering.js
class FeatureEngineer {
  createUserVector(userProfile) {
    return [
      userProfile.personalInfo.age / 100, // Normalize
      userProfile.personalInfo.gender === 'male' ? 1 : 0,
      userProfile.personalInfo.height / 200,
      userProfile.personalInfo.weight / 100,
      userProfile.isFamily ? 1 : 0,
      userProfile.familyInfo.children || 0,
      userProfile.familyInfo.adults || 0,
      this.encodeDietType(userProfile.dietaryPreferences.DietType_id),
      userProfile.nutritionGoals.caloriesPerDay / 3000,
      userProfile.nutritionGoals.proteinPercentage / 100,
      userProfile.nutritionGoals.carbPercentage / 100,
      userProfile.nutritionGoals.fatPercentage / 100,
      this.encodeActivityLevel(userProfile.lifestyle?.activityLevel),
      this.encodeCookingSkill(userProfile.lifestyle?.cookingSkill),
      // Add more features as needed
    ];
  }
  
  createMealVector(meal, ingredients) {
    const totalNutrition = this.calculateTotalNutrition(meal, ingredients);
    return [
      totalNutrition.calories / 1000,
      totalNutrition.protein / 100,
      totalNutrition.carbs / 100, 
      totalNutrition.fat / 100,
      meal.popularity || 0,
      this.encodeMealCategory(meal.mealCategory),
      meal.dietaryCompatibility.length / 5, // Flexibility score
      meal.ingredients.length / 10, // Complexity score
    ];
  }
}
```

STEP 2: KNN RECOMMENDATION SERVICE
---------------------------------
```javascript
// services/knnRecommendationService.js
const KNN = require('ml-knn');
const { Matrix } = require('ml-matrix');
const FeatureEngineer = require('../utils/featureEngineering');

class KNNMealRecommender {
  constructor() {
    this.knn = null;
    this.featureEngineer = new FeatureEngineer();
    this.userFeatures = [];
    this.mealPreferences = [];
    this.trained = false;
  }
  
  async trainFromGeneratedData() {
    console.log('üéØ Training KNN model...');
    
    // Load generated training data
    const TrainingData = require('../models/TrainingDataModel');
    const trainingData = await TrainingData.find({ dataQuality: 'ai_generated' });
    
    // Extract features and labels
    const features = [];
    const labels = [];
    
    for (const userData of trainingData) {
      const userVector = this.featureEngineer.createUserVector(userData.userProfile);
      
      // Extract meal preferences from history
      for (const day of userData.mealHistory.selections) {
        for (const timeSlot of ['breakfast', 'lunch', 'dinner']) {
          for (const meal of day[timeSlot]) {
            features.push([...userVector, ...this.getMealContext(timeSlot)]);
            labels.push({
              meal_id: meal.meal_id,
              satisfaction: meal.satisfied ? 1 : 0,
              portion: meal.portion
            });
          }
        }
      }
    }
    
    // Train KNN
    const featureMatrix = new Matrix(features);
    this.knn = new KNN(featureMatrix, labels, { k: 5 });
    this.trained = true;
    
    console.log(`‚úÖ KNN trained with ${features.length} data points`);
  }
  
  async recommend(userProfile, availableMeals, timeSlot = 'dinner') {
    if (!this.trained) {
      throw new Error('Model ch∆∞a ƒë∆∞·ª£c train! Ch·∫°y trainFromGeneratedData() tr∆∞·ªõc.');
    }
    
    const userVector = this.featureEngineer.createUserVector(userProfile);
    const context = this.getMealContext(timeSlot);
    const queryVector = [...userVector, ...context];
    
    // Get KNN predictions
    const predictions = this.knn.predict([queryVector]);
    
    // Score available meals
    const scoredMeals = availableMeals.map(meal => {
      const similarity = this.calculateSimilarity(queryVector, meal);
      return {
        ...meal,
        aiScore: similarity,
        recommendation_reason: this.generateReason(userProfile, meal)
      };
    });
    
    // Sort and return top recommendations
    return scoredMeals
      .sort((a, b) => b.aiScore - a.aiScore)
      .slice(0, 5);
  }
}
```

PHASE 3: HYBRID INTEGRATION (1 tu·∫ßn)
------------------------------------

FILE C·∫¶N T·∫†O:
- services/hybridAIService.js
- controller/AIRecommendationController.js

```javascript
// services/hybridAIService.js
class HybridAIRecommendationService {
  constructor() {
    this.knnService = new KNNMealRecommender();
    this.geminiService = new GeminiDataGenerator();
    this.fallbackRules = new SimpleRulesEngine();
  }
  
  async recommend(userProfile, availableMeals, preferences = {}) {
    try {
      // 1. Try KNN first (if trained and confident)
      if (this.knnService.trained) {
        const knnResults = await this.knnService.recommend(
          userProfile, availableMeals, preferences.timeSlot
        );
        
        if (knnResults.length > 0 && knnResults[0].aiScore > 0.7) {
          return {
            method: 'knn',
            confidence: knnResults[0].aiScore,
            recommendations: knnResults,
            reasoning: 'D·ª±a tr√™n pattern c·ªßa users t∆∞∆°ng t·ª±'
          };
        }
      }
      
      // 2. Fallback to Gemini for real-time recommendation
      const geminiPrompt = this.buildRecommendationPrompt(userProfile, availableMeals);
      const geminiResult = await this.geminiService.recommend(geminiPrompt);
      
      return {
        method: 'gemini',
        confidence: 0.8,
        recommendations: geminiResult,
        reasoning: 'AI analysis c·ªßa dietary needs v√† preferences'
      };
      
    } catch (error) {
      // 3. Ultimate fallback to rule-based
      console.warn('AI services failed, using rule-based fallback');
      const ruleResults = this.fallbackRules.recommend(userProfile, availableMeals);
      
      return {
        method: 'rules',
        confidence: 0.6,
        recommendations: ruleResults,
        reasoning: 'Basic dietary compatibility filtering'
      };
    }
  }
}
```

3. EXECUTION PLAN CHI TI·∫æT
==========================

TU·∫¶N 1: DATA GENERATION SETUP
-----------------------------

NG√ÄY 1-2: Project Structure
- T·∫°o folders: scripts/, models/, utils/
- Setup Gemini API connection
- Test basic AI generation

NG√ÄY 3-4: Profile Generator
- Implement GeminiDataGenerator class
- Create diverse user profile templates  
- Test generate 10 profiles

NG√ÄY 5-7: Meal History Generator
- Implement MealHistoryGenerator
- Connect to existing Meal API
- Generate meal selections cho 10 users

TU·∫¶N 2: SCALE UP DATA GENERATION
-------------------------------

NG√ÄY 8-10: Production Pipeline
- Optimize Gemini prompts for consistency
- Handle API rate limiting
- Batch processing cho 100+ profiles

NG√ÄY 11-14: Data Quality & Storage
- Validate generated data quality
- Save to TrainingDataModel MongoDB
- Export data for analysis

TU·∫¶N 3: KNN IMPLEMENTATION
-------------------------

NG√ÄY 15-17: Feature Engineering
- Implement FeatureEngineer class
- Test feature vectors
- Optimize feature selection

NG√ÄY 18-21: KNN Training & Testing
- Train KNN model v·ªõi generated data
- Test recommendations accuracy
- Fine-tune parameters

TU·∫¶N 4: INTEGRATION & DEPLOYMENT
-------------------------------

NG√ÄY 22-24: Hybrid Service
- Implement HybridAIRecommendationService
- Add to MealPlanController
- Create new API endpoints

NG√ÄY 25-28: Testing & Optimization
- End-to-end testing
- Performance optimization
- Deploy to production

4. SCRIPTS EXECUTION ORDER
=========================

```bash
# 1. Generate training data
node scripts/runDataGeneration.js --profiles=100 --days=30

# 2. Train KNN model
node scripts/trainKNNModel.js --data-source=generated

# 3. Test recommendations  
node scripts/testRecommendations.js --user-id=test --method=hybrid

# 4. Deploy to production
npm run deploy:meal-plan-service
```

5. API ENDPOINTS M·ªöI
===================

```javascript
// New endpoints in MealPlanController
POST /api/mealplans/ai-recommend
{
  "userProfile": {...},
  "preferences": {
    "timeSlot": "dinner", 
    "strictness": "medium",
    "variety": "high"
  }
}

POST /api/mealplans/generate-training-data (ADMIN only)
{
  "count": 100,
  "daysHistory": 30
}

GET /api/mealplans/ai-status
// Returns model status, training data count, etc.
```

6. MONITORING & METRICS
======================

METRICS C·∫¶N TRACK:
- Data generation success rate
- KNN model accuracy
- API response times
- User satisfaction v·ªõi AI recommendations
- Gemini API costs

LOGGING:
- All AI generation requests
- Model training sessions
- Recommendation performance
- Fallback usage frequency

7. PHASE TIMELINE
================

‚úÖ WEEK 1: Gemini Data Generator (100 profiles)
üîÑ WEEK 2: Scale to 500+ profiles + histories  
‚è≥ WEEK 3: KNN training + testing
üöÄ WEEK 4: Hybrid integration + deployment

MILESTONE CHECKPOINTS:
- Day 7: 100 realistic user profiles generated
- Day 14: 500+ profiles v·ªõi meal histories  
- Day 21: KNN model trained v√† tested
- Day 28: Production deployment v·ªõi monitoring

===========================================
K·∫æT LU·∫¨N: CHI·∫æN L∆Ø·ª¢C N√ÄY COMBINE T·ªêT NH·∫§T
C·ª¶A AI GENERATION + TRADITIONAL ML, T·∫†O RA
H·ªÜ TH·ªêNG RECOMMENDATION M·∫†NH M·∫º V√Ä SCALABLE
===========================================
